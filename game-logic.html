<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Dodger Logic</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; font-family: 'Segoe UI', sans-serif; touch-action: none; user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* UI Overlay Layout */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 15px; box-sizing: border-box; }
        .ui-bar { display: flex; justify-content: space-between; width: 100%; pointer-events: auto; }
        
        /* Left UI: Stats */
        .stats-left { color: #fbbf24; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-size: 18px; }
        #lives-display { color: #ef4444; font-size: 20px; letter-spacing: 2px; margin-top: 5px; }

        /* Right UI: Icons */
        .icon-bar { display: flex; gap: 15px; color: white; font-size: 22px; cursor: pointer; }
        .icon-bar i:hover { color: #3b82f6; transform: scale(1.1); }
        .hidden { display: none !important; }

        /* Screens */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; backdrop-filter: blur(5px); z-index: 100; color: white; }
        button { background: #3b82f6; color: white; border: none; padding: 15px 40px; font-size: 20px; border-radius: 50px; cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 20px; }
        
        #fire-btn { pointer-events: auto; width: 70px; height: 70px; border-radius: 50%; background: rgba(239, 68, 68, 0.6); border: 2px solid white; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; align-self: flex-end; }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="ui-bar">
            <div class="stats-left">
                <div>LEVEL: <span id="level-val">1</span></div>
                <div>SCORE: <span id="score-val">0000</span></div>
                <div id="lives-display">❤️❤️❤️</div>
            </div>

            <div class="icon-bar">
                <i id="earth-icon" class="fas fa-globe-americas hidden" title="Global High Scores" onclick="alert('Global Scores coming soon!')"></i>
                <i class="fas fa-trophy" title="Hall of Fame" onclick="alert('Hall of Fame: No scores yet!')"></i>
                <i class="fas fa-question-circle" title="Instructions" onclick="alert('Move mouse/touch to dodge. Click/Space to fire lasers. Collect yellow stars!')"></i>
                <i id="sound-toggle" class="fas fa-volume-up" title="Toggle Sound" onclick="toggleAudio()"></i>
            </div>
        </div>
        
        <div id="fire-btn" onmousedown="startFiring(event)" onmouseup="stopFiring(event)" ontouchstart="startFiring(event)" ontouchend="stopFiring(event)">FIRE</div>
    </div>

    <div id="start-screen" class="screen">
        <h1 style="color: #60a5fa; font-size: 48px; text-align: center;">YERTAL LAB<br><span style="font-size: 18px; color: #94a3b8;">SPACE DODGER PRO</span></h1>
        <button onclick="startGame()">Initialize System</button>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: #ef4444;">MISSION FAILED</h1>
        <p id="final-stats" style="font-size: 20px;"></p>
        <p id="login-msg" style="color: #94a3b8; font-size: 14px; margin-top: 20px;">Want to save this score? Log in to Yertal.</p>
        <button onclick="startGame()">Re-Launch</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let isPlaying = false, score = 0, lives = 3, level = 1, dodgedCount = 0;
        let isAudioOn = true, isLoggedIn = false; // Set isLoggedIn to true to see the Earth icon
        let player = { x: 0, y: 0, width: 50, height: 75, targetX: 0, tilt: 0, cooldown: 0 };
        let enemies = [], bullets = [], bgStars = [], bonusStars = [];
        let isFiring = false;

        // --- Improved Audio System ---
        const AudioSys = {
            ctx: null,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playLevelUp() {
                if(!isAudioOn || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                osc.connect(gain).connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.2);
            },
            playShoot() { /* ... similar to previous ... */ },
            playExplosion() { /* ... similar to previous ... */ }
        };

        function toggleAudio() {
            isAudioOn = !isAudioOn;
            document.getElementById('sound-toggle').className = isAudioOn ? 'fas fa-volume-up' : 'fas fa-volume-mute';
        }

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();

        // Mouse/Click Firing
        window.addEventListener('mousemove', e => { if(isPlaying) player.targetX = e.clientX; });
        window.addEventListener('mousedown', () => { if(isPlaying) isFiring = true; });
        window.addEventListener('mouseup', () => isFiring = false);
        window.addEventListener('keydown', e => { if(e.code === 'Space') isFiring = true; });
        window.addEventListener('keyup', e => { if(e.code === 'Space') isFiring = false; });

        function startFiring(e) { e.stopPropagation(); isFiring = true; }
        function stopFiring(e) { e.stopPropagation(); isFiring = false; }

        function drawPlayer() {
            player.x += (player.targetX - player.x) * 0.15;
            player.tilt = (player.targetX - player.x) * 0.05;
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(Math.max(-0.2, Math.min(0.2, player.tilt * 0.01)));
            
            // 3D-ish Rocket Body
            ctx.fillStyle = '#1e40af'; // Dark Blue Side
            ctx.beginPath(); ctx.moveTo(-25, 30); ctx.lineTo(0, -45); ctx.lineTo(0, 20); ctx.fill();
            ctx.fillStyle = '#3b82f6'; // Light Blue Side
            ctx.beginPath(); ctx.moveTo(25, 30); ctx.lineTo(0, -45); ctx.lineTo(0, 20); ctx.fill();
            
            // Cockpit
            ctx.fillStyle = '#e2e8f0';
            ctx.beginPath(); ctx.ellipse(0, -10, 8, 15, 0, 0, Math.PI*2); ctx.fill();
            
            // Engine Flame
            ctx.fillStyle = '#f97316';
            ctx.beginPath(); ctx.moveTo(-10, 25); ctx.lineTo(10, 25); ctx.lineTo(0, 45 + Math.random()*15); ctx.fill();
            ctx.restore();
        }

        function loop() {
            if(!isPlaying) return;
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,canvas.width, canvas.height);

            // Background Stars
            ctx.fillStyle = 'white';
            bgStars.forEach(s => {
                s.y += s.s; if(s.y > canvas.height) s.y = 0;
                ctx.globalAlpha = s.a; ctx.fillRect(s.x, s.y, 2, 2);
            });
            ctx.globalAlpha = 1;

            drawPlayer();

            // Handling Bonus Yellow Stars
            if(Math.random() < 0.01) bonusStars.push({x: Math.random()*canvas.width, y: -20, s: 2});
            bonusStars.forEach((s, i) => {
                s.y += s.s;
                ctx.fillStyle = '#fbbf24';
                ctx.beginPath(); ctx.arc(s.x, s.y, 5, 0, Math.PI*2); ctx.fill();
                // Collection
                if(Math.hypot(player.x - s.x, player.y - s.y) < 40) {
                    score += 50; bonusStars.splice(i, 1);
                }
            });

            // Enemy Logic (Level scaling speed)
            if(frames % Math.max(20, 60 - level*5) === 0) {
                enemies.push({x: Math.random()*canvas.width, y: -50, r: 20, s: 3 + (level*0.5)});
            }

            enemies.forEach((e, i) => {
                e.y += e.s;
                ctx.fillStyle = '#ef4444';
                ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill();

                if(Math.hypot(player.x - e.x, player.y - e.y) < e.r + 25) {
                    lives--; enemies.splice(i, 1);
                    document.getElementById('lives-display').innerText = "❤️".repeat(lives);
                    if(lives <= 0) endGame();
                }

                if(e.y > canvas.height) {
                    enemies.splice(i, 1);
                    dodgedCount++;
                    if(dodgedCount >= 20) {
                        level++; dodgedCount = 0;
                        AudioSys.playLevelUp();
                        document.getElementById('level-val').innerText = level;
                    }
                }
            });

            // Firing Logic
            if(isFiring && player.cooldown <= 0) {
                bullets.push({x: player.x, y: player.y - 40});
                player.cooldown = 15;
            }
            if(player.cooldown > 0) player.cooldown--;

            bullets.forEach((b, i) => {
                b.y -= 10;
                ctx.fillStyle = '#22d3ee';
                ctx.fillRect(b.x-2, b.y, 4, 15);
                if(b.y < 0) bullets.splice(i, 1);
            });

            frames++;
            score++;
            document.getElementById('score-val').innerText = score.toString().padStart(4, '0');
            requestAnimationFrame(loop);
        }

        function startGame() {
            AudioSys.init();
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            score = 0; lives = 3; level = 1; dodgedCount = 0; enemies = []; bullets = []; bonusStars = []; frames = 0;
            bgStars = Array.from({length:50}, () => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2+0.5, a: Math.random()}));
            player.x = canvas.width/2; player.y = canvas.height - 120;
            document.getElementById('earth-icon').classList.toggle('hidden', !isLoggedIn);
            isPlaying = true; loop();
        }

        function endGame() {
            isPlaying = false;
            document.getElementById('final-stats').innerText = `Final Score: ${score} | Level: ${level}`;
            document.getElementById('game-over-screen').classList.remove('hidden');
        }
    </script>
</body>
</html>
