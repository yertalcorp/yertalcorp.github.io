<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Dodger Logic</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; font-family: 'Segoe UI', sans-serif; touch-action: none; user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; }
        #score-board { font-size: 24px; font-weight: bold; color: #fbbf24; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #lives-board { font-size: 24px; letter-spacing: 5px; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; backdrop-filter: blur(5px); z-index: 10; transition: opacity 0.3s; }
        .hidden { display: none !important; }
        h1 { margin: 0 0 20px 0; font-size: 40px; color: #60a5fa; text-transform: uppercase; text-align: center; }
        button { background: #3b82f6; color: white; border: none; padding: 15px 40px; font-size: 20px; border-radius: 50px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        #fire-btn { pointer-events: auto; width: 80px; height: 80px; border-radius: 50%; background: #ef4444; border: 3px solid rgba(255,255,255,0.2); color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 18px; touch-action: manipulation; box-shadow: 0 5px 15px rgba(0,0,0,0.3); align-self: flex-end; }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div style="display: flex; justify-content: space-between; width: 100%;">
            <div id="score-board">0000</div>
            <div id="lives-board">❤️❤️❤️</div>
        </div>
        <!-- Fire Button for Mobile -->
        <div id="fire-btn" ontouchstart="startFiring(event)" ontouchend="stopFiring(event)" onmousedown="startFiring(event)" onmouseup="stopFiring(event)">FIRE</div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen">
        <h1>Yertal Lab<br><span style="font-size: 20px; color: #94a3b8;">Space Dodger v1.0</span></h1>
        <button onclick="startGame()">Initialize System</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: #ef4444;">Mission Failed</h1>
        <p style="color: white; font-size: 24px; margin-bottom: 20px;">Score: <span id="final-score">0</span></p>
        <button onclick="startGame()">Re-Launch</button>
    </div>

    <script>
        // --- Audio System ---
        const AudioSys = {
            ctx: null, bgOsc: null,
            init: function() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if(this.ctx.state === 'suspended') this.ctx.resume(); },
            startBGM: function() {
                this.init(); if(this.bgOsc) return;
                this.bgOsc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                this.bgOsc.type = 'sawtooth'; this.bgOsc.frequency.value = 50;
                gain.gain.value = 0.02;
                this.bgOsc.connect(gain).connect(this.ctx.destination);
                this.bgOsc.start();
            },
            stopBGM: function() { if(this.bgOsc) { this.bgOsc.stop(); this.bgOsc = null; } },
            playShoot: function() {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square'; osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.connect(gain).connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.1);
            },
            playExplosion: function() {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                osc.connect(gain).connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.3);
            }
        };

        // --- Game Engine ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let isPlaying = false, score = 0, lives = 3, frames = 0;
        let player = { x: 0, y: 0, width: 40, height: 60, targetX: 0, tilt: 0, cooldown: 0 };
        let enemies = [], bullets = [], stars = [];
        let isFiring = false;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(!isPlaying) { player.x = canvas.width/2; player.y = canvas.height - 120; player.targetX = player.x; }
        }
        window.addEventListener('resize', resize);
        resize();

        // Input Handling
        window.addEventListener('mousemove', e => { if(isPlaying) player.targetX = e.clientX; });
        window.addEventListener('touchmove', e => { if(isPlaying) { e.preventDefault(); player.targetX = e.touches[0].clientX; }}, { passive: false });
        window.addEventListener('keydown', e => { if(e.code === 'Space') isFiring = true; });
        window.addEventListener('keyup', e => { if(e.code === 'Space') isFiring = false; });
        function startFiring(e) { if(e) e.stopPropagation(); isFiring = true; }
        function stopFiring(e) { if(e) e.stopPropagation(); isFiring = false; }

        function loop() {
            if(!isPlaying) return;
            
            // 1. Clear & Background
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,canvas.width, canvas.height);
            
            // Stars
            ctx.fillStyle = 'white';
            stars.forEach(s => {
                s.y += s.s; if(s.y > canvas.height) s.y = 0;
                ctx.globalAlpha = s.a; ctx.fillRect(s.x, s.y, 2, 2);
            });
            ctx.globalAlpha = 1;

            // 2. Player
            player.x += (player.targetX - player.x) * 0.15;
            player.tilt = (player.targetX - player.x) * 0.05;
            
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(Math.max(-0.2, Math.min(0.2, player.tilt * 0.01)));
            
            // Ship Graphics
            ctx.fillStyle = '#f97316'; // Engine
            ctx.beginPath(); ctx.moveTo(-5, 30); ctx.lineTo(5, 30); ctx.lineTo(0, 40 + Math.random()*10); ctx.fill();
            
            ctx.fillStyle = '#3b82f6'; // Body
            ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(-20, 30); ctx.lineTo(0, 20); ctx.lineTo(20, 30); ctx.fill();
            
            ctx.fillStyle = '#93c5fd'; // Cockpit
            ctx.beginPath(); ctx.ellipse(0, -5, 6, 12, 0, 0, Math.PI*2); ctx.fill();
            ctx.restore();

            // 3. Shooting
            if(player.cooldown > 0) player.cooldown--;
            if(isFiring && player.cooldown <= 0) {
                bullets.push({x: player.x, y: player.y - 35});
                AudioSys.playShoot();
                player.cooldown = 10;
            }

            // 4. Bullets
            ctx.fillStyle = '#67e8f9';
            for(let i=0; i<bullets.length; i++) {
                bullets[i].y -= 15;
                ctx.fillRect(bullets[i].x-2, bullets[i].y, 4, 12);
                if(bullets[i].y < -20) { bullets.splice(i,1); i--; }
            }

            // 5. Enemies
            if(frames % 60 === 0) enemies.push({x: Math.random()*canvas.width, y: -50, r: 20+Math.random()*20, s: 3+Math.random()*2, hp: 2});
            
            enemies.forEach((e, i) => {
                e.y += e.s;
                // Asteroid Graphics
                const grad = ctx.createRadialGradient(e.x-5, e.y-5, 2, e.x, e.y, e.r);
                grad.addColorStop(0, '#fca5a5'); grad.addColorStop(1, '#991b1b');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill();

                // Player Collision
                if(Math.hypot(player.x - e.x, player.y - e.y) < e.r + 20) {
                    lives--; AudioSys.playExplosion();
                    document.getElementById('lives-board').innerText = "❤️".repeat(lives);
                    enemies.splice(i, 1);
                    if(lives <= 0) endGame();
                }

                // Bullet Collision
                for(let j=0; j<bullets.length; j++) {
                    if(Math.hypot(bullets[j].x - e.x, bullets[j].y - e.y) < e.r) {
                        e.hp--; bullets.splice(j,1); j--;
                        if(e.hp <= 0) {
                            enemies.splice(i,1); score += 10; AudioSys.playExplosion();
                            document.getElementById('score-board').innerText = score.toString().padStart(4,'0');
                        }
                        break;
                    }
                }
                if(e.y > canvas.height + 50) enemies.splice(i, 1);
            });

            frames++;
            score++;
            if(frames % 10 === 0) document.getElementById('score-board').innerText = score.toString().padStart(4,'0');
            requestAnimationFrame(loop);
        }

        function startGame() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            score = 0; lives = 3; enemies = []; bullets = []; frames = 0;
            stars = Array.from({length:50}, () => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2+0.5, a: Math.random()}));
            player.x = canvas.width/2; player.y = canvas.height - 120;
            document.getElementById('lives-board').innerText = "❤️❤️❤️";
            isPlaying = true;
            AudioSys.startBGM();
            loop();
        }

        function endGame() {
            isPlaying = false;
            AudioSys.stopBGM();
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-over-screen').classList.remove('hidden');
        }
    </script>
</body>
</html>
